<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${vehiculo.idVehiculo} ? 'Editar Vehículo' : 'Nuevo Vehículo'">Vehículo - INGECAR</title>
    <link rel="stylesheet" th:href="@{/css/vehiculo-form.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
    <header class="dashboard-header">
        <div class="header-container">
            <div class="logo-section">
                <div class="logo-icon">
                    <i class="fas fa-car-alt"></i>
                </div>
                <h1>Taller Automotriz INGECAR</h1>
            </div>
            <nav class="main-nav">
                <a href="/" class="nav-link">
                    <i class="fas fa-home"></i>
                    <span>Inicio</span>
                </a>
                <a href="/clientes" class="nav-link">
                    <i class="fas fa-users"></i>
                    <span>Clientes</span>
                </a>
                <a href="/ordenes" class="nav-link">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Órdenes</span>
                </a>
                <a href="/catalogos" class="nav-link">
                    <i class="fas fa-tools"></i>
                    <span>Servicios</span>
                </a>
                <a href="/reportes" class="nav-link">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reportes</span>
                </a>
                <a href="/usuarios" class="nav-link">
                    <i class="fas fa-user-cog"></i>
                    <span>Usuarios</span>
                </a>
                <a href="/auth/logout" class="nav-link logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Salir</span>
                </a>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <div class="page-title">
                    <div class="page-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <h1 th:text="${vehiculo.idVehiculo} ? 'Editar Vehículo' : 'Nuevo Vehículo'"></h1>
                </div>
                <a th:href="@{/clientes/detalle/{dni}(dni=${vehiculo.cliente.dni})}" class="btn-back">
                    <i class="fas fa-arrow-left"></i>
                    Volver al Cliente
                </a>
            </div>
            
            <div class="form-card">
                <div class="client-info">
                    <div class="client-avatar">
                        [[${#strings.substring(vehiculo.cliente.nombreCompleto, 0, 1)}]]
                    </div>
                    <div class="client-details">
                        <h4>[[${vehiculo.cliente.nombreCompleto}]]</h4>
                        <p>DNI: [[${vehiculo.cliente.dni}]] - Este vehículo será registrado a nombre de este cliente</p>
                    </div>
                </div>
                
                <form th:action="@{/vehiculos/guardar}" method="post" th:object="${vehiculo}" id="vehicleForm" autocomplete="off">
                    <input type="hidden" th:field="*{idVehiculo}">
                    <input type="hidden" th:field="*{cliente.idCliente}">
                    
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-id-card"></i>
                            Identificación del Vehículo
                        </h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-car"></i>
                                    Placa *
                                </label>
                                <input type="text" th:field="*{placa}" class="form-control plate-input" required 
                                       placeholder="Ej: ABC-123" id="placaInput" autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-industry"></i>
                                    Marca *
                                </label>
                                <input type="text" th:field="*{marca}" class="form-control" required 
                                       placeholder="Ej: Toyota, Hyundai, etc." autocomplete="off" autocorrect="off" spellcheck="false">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-car-side"></i>
                                    Modelo *
                                </label>
                                <input type="text" th:field="*{modelo}" class="form-control" required 
                                       placeholder="Ej: Corolla, Tucson, etc." autocomplete="off" autocorrect="off" spellcheck="false">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-cogs"></i>
                            Especificaciones Técnicas
                        </h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-calendar-alt"></i>
                                    Año
                                </label>
                                <input type="number" th:field="*{anio}" class="form-control" 
                                       placeholder="Ej: 2020" autocomplete="off">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-palette"></i>
                                    Color
                                </label>
                                <div class="color-input-group">
                                    <input type="text" th:field="*{color}" class="form-control" 
                                           placeholder="Ej: Rojo, Azul, etc." id="colorInput" autocomplete="off" autocorrect="off" spellcheck="false">
                                    <div class="color-preview" id="colorPreview" title="Haz clic para seleccionar color"></div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-tachometer-alt"></i>
                                    Kilometraje (km)
                                </label>
                                <input type="number" th:field="*{kilometraje}" class="form-control" 
                                       placeholder="Ej: 45000" autocomplete="off">
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            <span th:text="${vehiculo.idVehiculo} ? 'Actualizar Vehículo' : 'Registrar Vehículo'"></span>
                        </button>
                        <a th:href="@{/clientes/detalle/{dni}(dni=${vehiculo.cliente.dni})}" class="btn btn-secondary">
                            <i class="fas fa-times"></i>
                            Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <footer class="dashboard-footer-main">
        <div class="footer-container">
            <p>Sistema de Gestión de Órdenes - Taller INGECAR &copy; 2023</p>
            <div class="footer-links">
                <span><i class="fas fa-phone"></i> 921230909</span>
                <span><i class="fas fa-map-marker-alt"></i> Quenaya, Puno</span>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Formatear placa automáticamente con formato peruano
            const placaInput = document.getElementById('placaInput');
            if (placaInput) {
                // Deshabilitar autocorrección nativo del navegador
                placaInput.setAttribute('autocomplete', 'off');
                placaInput.setAttribute('autocorrect', 'off');
                placaInput.setAttribute('autocapitalize', 'characters');
                placaInput.setAttribute('spellcheck', 'false');
                
                placaInput.addEventListener('input', function(e) {
                    // Eliminar guiones y espacios, convertir a mayúsculas
                    let value = e.target.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
                    
                    // Insertar guión automáticamente según el formato
                    if (value.length > 0) {
                        // Formato especial: O, T, E, R, CD seguido de números
                        if (value.match(/^(O|T|E|R|CD)/i)) {
                            if (value.length > 1) {
                                // Para placas especiales: O-12345, T-12345, etc.
                                value = value.substring(0, value.match(/^(O|T|E|R|CD)/i)[0].length) + 
                                        '-' + value.substring(value.match(/^(O|T|E|R|CD)/i)[0].length);
                            }
                        }
                        // Formato ABC-123 (3 letras + 3 números)
                        else if (value.length > 3 && value.substring(0, 3).match(/^[A-Z]{3}$/)) {
                            value = value.substring(0, 3) + '-' + value.substring(3, 6);
                        }
                        // Formato AB-1234 (2 letras + 4 números)
                        else if (value.length > 2 && value.substring(0, 2).match(/^[A-Z]{2}$/)) {
                            value = value.substring(0, 2) + '-' + value.substring(2, 6);
                        }
                        // Formato A-12345 (1 letra + 5 números) - antiguo
                        else if (value.length > 1 && value.substring(0, 1).match(/^[A-Z]$/)) {
                            value = value.substring(0, 1) + '-' + value.substring(1, 6);
                        }
                    }
                    
                    e.target.value = value;
                });
                
                // Prevenir comportamiento por defecto del autocomplete
                placaInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Tab' || e.key === 'Enter') {
                        this.blur();
                    }
                });
            }
            
            // Deshabilitar autocomplete para todos los inputs
            document.querySelectorAll('input').forEach(input => {
                input.setAttribute('autocomplete', 'off');
                input.setAttribute('autocorrect', 'off');
                input.setAttribute('spellcheck', 'false');
            });
            
            // Color preview functionality
            const colorInput = document.getElementById('colorInput');
            const colorPreview = document.getElementById('colorPreview');
            
            if (colorInput && colorPreview) {
                // Deshabilitar autocomplete para el color
                colorInput.setAttribute('autocomplete', 'off');
                colorInput.setAttribute('autocorrect', 'off');
                colorInput.setAttribute('spellcheck', 'false');
                
                // Set initial color
                updateColorPreview(colorInput.value);
                
                // Update on input
                colorInput.addEventListener('input', function() {
                    updateColorPreview(this.value);
                });
                
                function updateColorPreview(colorName) {
                    const colorHex = getColorHex(colorName);
                    if (colorHex) {
                        colorPreview.style.backgroundColor = colorHex;
                        colorPreview.title = colorName + ' - ' + colorHex;
                    } else {
                        // Intentar detectar si es un código de color
                        if (colorName.match(/^#?[0-9a-f]{6}$/i)) {
                            const hex = colorName.startsWith('#') ? colorName : '#' + colorName;
                            colorPreview.style.backgroundColor = hex;
                            colorPreview.title = colorName;
                        } else if (colorName.match(/^rgb\(/)) {
                            colorPreview.style.backgroundColor = colorName;
                            colorPreview.title = colorName;
                        } else {
                            colorPreview.style.backgroundColor = '#f8f9fa';
                            colorPreview.title = 'Haz clic para seleccionar color';
                        }
                    }
                }
                
                function getColorHex(colorName) {
                    const colors = {
                        'rojo': '#ff0000', 'red': '#ff0000',
                        'azul': '#0000ff', 'blue': '#0000ff',
                        'verde': '#00ff00', 'green': '#00ff00',
                        'amarillo': '#ffff00', 'yellow': '#ffff00',
                        'negro': '#000000', 'black': '#000000',
                        'blanco': '#ffffff', 'white': '#ffffff',
                        'gris': '#808080', 'gray': '#808080', 'grey': '#808080',
                        'plateado': '#c0c0c0', 'silver': '#c0c0c0',
                        'dorado': '#ffd700', 'gold': '#ffd700',
                        'naranja': '#ffa500', 'orange': '#ffa500',
                        'morado': '#800080', 'purple': '#800080',
                        'rosa': '#ffc0cb', 'pink': '#ffc0cb',
                        'marrón': '#a52a2a', 'brown': '#a52a2a', 'marron': '#a52a2a',
                        'beige': '#f5f5dc',
                        'celeste': '#87ceeb', 'skyblue': '#87ceeb',
                        'turquesa': '#40e0d0', 'turquoise': '#40e0d0',
                        'violeta': '#ee82ee', 'violet': '#ee82ee'
                    };
                    
                    const cleanName = colorName.toLowerCase().trim();
                    return colors[cleanName];
                }
                
                // Color picker functionality
                colorPreview.addEventListener('click', function() {
                    const colors = [
                        {name: 'Rojo', value: 'Rojo'},
                        {name: 'Azul', value: 'Azul'},
                        {name: 'Verde', value: 'Verde'},
                        {name: 'Amarillo', value: 'Amarillo'},
                        {name: 'Negro', value: 'Negro'},
                        {name: 'Blanco', value: 'Blanco'},
                        {name: 'Gris', value: 'Gris'},
                        {name: 'Plateado', value: 'Plateado'},
                        {name: 'Dorado', value: 'Dorado'},
                        {name: 'Naranja', value: 'Naranja'},
                        {name: 'Morado', value: 'Morado'},
                        {name: 'Rosa', value: 'Rosa'},
                        {name: 'Marrón', value: 'Marrón'},
                        {name: 'Beige', value: 'Beige'},
                        {name: 'Celeste', value: 'Celeste'},
                        {name: 'Turquesa', value: 'Turquesa'}
                    ];
                    
                    let colorList = 'Colores comunes:\n\n';
                    colors.forEach((color, index) => {
                        colorList += `${index + 1}. ${color.name}\n`;
                    });
                    colorList += '\nO ingresa un color personalizado:';
                    
                    const userColor = prompt(`${colorList}`);
                    
                    if (userColor !== null && userColor.trim() !== '') {
                        const num = parseInt(userColor);
                        if (num >= 1 && num <= 16) {
                            colorInput.value = colors[num - 1].value;
                        } else {
                            colorInput.value = userColor;
                        }
                        updateColorPreview(colorInput.value);
                        colorInput.focus();
                    }
                });
            }
            
            // Form validation
            const vehicleForm = document.getElementById('vehicleForm');
            if (vehicleForm) {
                vehicleForm.addEventListener('submit', function(e) {
                    const plate = this.querySelector('[name="placa"]').value.trim();
                    const marca = this.querySelector('[name="marca"]').value.trim();
                    const modelo = this.querySelector('[name="modelo"]').value.trim();
                    
                    // Campos obligatorios
                    if (!plate || !marca || !modelo) {
                        e.preventDefault();
                        alert('Por favor complete los campos obligatorios (*)');
                        return false;
                    }
                    
                    return true;
                });
            }
            
            // Prevenir que el navegador guarde datos del formulario
            document.addEventListener('DOMContentLoaded', function() {
                // Deshabilitar autocomplete en todo el documento
                document.body.setAttribute('autocomplete', 'off');
                
                // Deshabilitar predicciones de formulario
                const form = document.getElementById('vehicleForm');
                if (form) {
                    form.setAttribute('autocomplete', 'off');
                    form.setAttribute('novalidate', 'novalidate');
                }
            });
        });
    </script>
</body>
</html>